const t="undefined"!=typeof unsafeWindow,e=()=>{},s=t?unsafeWindow:globalThis??window,{JSON:i,document:r}=s,n=t=>void 0===t,a=t=>"string"==typeof t,h=t=>Number.isInteger(t),o=t=>h(t)||(t=>(t=>"number"==typeof t)(t)&&parseFloat(t)===t)(t)||/^-?(?:[\d]+\.)?\d+$/.test(t),c=t=>Array.isArray(t),u=t=>"function"==typeof t;function l(t){return u(t)?t.name:t instanceof Object?Object.getPrototypeOf(t).constructor.name:void 0}function d(t,...e){u(t)&&setTimeout(t,0,...e)}function g(t=""){if(!a(t))throw new TypeError("name must be a String");let e;for(;-1<(e=t.indexOf("-"));)t=t.slice(0,e)+t.slice(e+1,1).toUpperCase()+t.slice(e+2);return t}function m(t){if(n(t)||null===t)return null;if(function(t){return!!a(t)&&(o(t)||["true","false","null"].includes(t)||["{","[",'"'].includes(t.slice(0,1))||["}","]",'"'].includes(t.slice(-1)))}(t))try{return i.parse(t)}catch(e){return t}return t}function p(t){return u(t)||n(t)||a(t)?t:i.stringify(t)}class f{static get default(){return this.cases()[0]}static tryFrom(t){return l(t)!==l(this)||u(t)?this.cases().find((e=>e.value===t)):t}static from(t){const e=this.tryFrom(t);if(n(e))throw new TypeError("Cannot find matching enum to: "+p(t));return e}static cases(){return this.keys.map((t=>this[t]))}static get keys(){return Object.keys(this).filter((t=>t[0]===t[0].toUpperCase()&&this[t]instanceof f))}static get size(){return this.keys.length}get name(){return Object.keys(this.constructor).find((t=>this.constructor[t]===this))??""}constructor(t){if(Object.getPrototypeOf(this)===f.prototype)throw new Error("Cannot instantiate BackedEnum directly, it must be extended.");if(n(t)||u(t))throw new TypeError("value is not valid");Object.defineProperty(this,"value",{writable:!1,configurable:!1,enumerable:!0,value:t})}}const w=36e5,y={days:864e5,hours:w,minutes:6e4,seconds:1e3,miliseconds:1};class x{#t=0;#e=!1;#s=!1;#i=0;#r;get startTime(){return this.#t}get stopped(){return 0===this.#t}get running(){return this.#e}get paused(){return this.#s}get elapsed(){return this.#e?+new Date-this.#t:this.#i}get laps(){return this.#r}start(){this.#e||this.#t||(this.#e=!0,this.#r=[],this.#i=0,this.#t=+new Date)}stop(){if(!this.#e)return this.#i;this.#e=!1;let t=this.#t;return this.#t=0,this.#i=+new Date-t}pause(){return!this.#s&&this.#e&&(this.#s=!0,this.#e=!1,this.#i=+new Date-this.#t),this.#i}resume(){this.#s&&!this.stopped&&(this.#s=!1,this.#e=!0,this.#t=+new Date-this.#i)}lap(){let t=this.#r[this.#r.length-1];if(!this.#e)return t??0;let e=t??this.#t,s=this.elapsed-e;return this.#r.push(s),s}constructor(t=!0){this.#r=[],t&&this.start()}}class v{#n;#a;get data(){return this.#a}get days(){return""+this.#a.days}get hours(){return this.#a.hours<10?`0${this.#a.hours}`:`${this.#a.hours}`}get minutes(){return this.#a.minutes<10?`0${this.#a.minutes}`:`${this.#a.minutes}`}get seconds(){return this.#a.seconds<10?`0${this.#a.seconds}`:`${this.#a.seconds}`}get miliseconds(){return this.#a.miliseconds<10?this.#a.miliseconds<100?"00"+this.#a.miliseconds:"0"+this.#a.miliseconds:""+this.#a.miliseconds}get timestamp(){return this.#n}static of(t){return new v(t)}constructor(t){if(!h(t))throw new TypeError("timestamp must be an integer");this.#n=t,this.#a={};for(let e in y){let s=y[e],i=Math.floor(t/s);t-=i*s,this.#a[e]=i}}toString(){return`${this.days}d ${this.hours}:${this.minutes}:${this.seconds}.${this.miliseconds}s`}export(){return Object.assign({timestamp:this.#n},this.#a)}}class E{static of(t){return new E(t)}min={x:0,y:0};max={x:0,y:0};constructor({x:t,y:e,width:s,height:i}){let r=Math.floor(s/4),n=Math.floor(i/4);this.min.x=t+r,this.max.x=t+s-r,this.min.y=e+n,this.max.y=e+i-n}intersects(t){return t instanceof E!=!1&&!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)}}class b{world;get x(){throw new Error(l(this)+".x not implemented")}get y(){throw new Error(l(this)+".y not implemented")}get width(){throw new Error(l(this)+".width not implemented")}get height(){throw new Error(l(this)+".height not implemented")}isEnemy=!1;get scoreGain(){return 0}get name(){return l(this)}get ctx(){return this.world.ctx}get box(){return E.of(this)}isIntersecting(t){return t instanceof b!=!1&&this.box.intersects(t.box)}draw(){throw new Error(l(this)+".draw() is not implemented")}constructor(t){if(t instanceof z==!1)throw new TypeError("Invalid world !!!");this.world=t}destroy(){this.destroyed=!0}}const S="./assets/pictures",A=S+"/worlds",I=S+"/hiro",O=S+"/enemy";let j=0;const k=new Set;const T=function(t=e){let s=0;return e=>{s++,j++,e.onload=()=>{s--,j--,0===s&&(t(),0===j&&k.forEach((t=>t())))}}}();function M(t,e=!0){let s=0,i=0;const r=t.map((t=>{const e=new Image;return T(e),e.src=t,e}));return()=>{let t=!0;return i++,i%4==0&&s++,s>=r.length&&(s=0,t=e),t&&r[s]}}const Y=new Map([["moving",[[...Array(9)].map(((t,e)=>I+"/moving/"+(e+1)+".png")),!0]],["attacking",[[...Array(6)].map(((t,e)=>I+"/attacking/"+(e+1)+".png")),!1]]]);class G extends f{static MOVING=new G("moving");static ATTACKING=new G("attacking");get sprites(){return Y.get(this.value)[0]}#h;getAnimation(){return this.#h??=M(...Y.get(this.value))}}class N extends b{hp=6;killCount=0;x=100;y=350;width=150;height=150;minY=150;maxY=350;gravity=1;jumpStep=15;deltaY=0;isJumping=!1;isAttacking=!1;state=G.MOVING;currentSprite=!1;intercepting=[];draw(){const{ctx:t}=this;this.isJumping&&this.jump(),this.isAttacking&&this.attack(),this.isAttacking||this.move(),this.intersections(),t.drawImage(this.currentSprite,this.x,this.y,this.width,this.height)}move(){this.state=G.MOVING,this.currentSprite=this.state.getAnimation(this)()}attack(){this.isAttacking&&(this.state=G.ATTACKING,!1===(this.currentSprite=this.state.getAnimation(this)())&&(this.isAttacking=!1)),this.isAttacking||(this.state=G.MOVING,this.move())}jump(){if(this.isJumping){if(0===this.deltaY)this.deltaY=-this.jumpStep*this.gravity;else if(this.y<=this.minY)this.deltaY=-1*this.deltaY,this.y=this.minY;else if(this.y>=this.maxY)return this.deltaY=0,this.isJumping=!1,void(this.y=this.maxY);this.y+=this.deltaY}}intersections(){this.intercepting=this.intercepting.filter((t=>!(t.destroyed||!t.isIntersecting(this))));for(let t of[...this.world.objects])t.isIntersecting(this)&&!this.intercepting.includes(t)&&t.scoreGain>0&&(this.intercepting.push(t),!t.isEnemy||this.isAttacking?(this.world.score+=t.scoreGain,this.world.destroyObject(t),t.isEnemy&&(this.killCount++,this.world.stage.generateEnemy()),this.world.trigger("scoregain",{item:t})):t.isEnemy&&(this.hp--,this.world.trigger("hploss",{item:t}),this.hp<=0&&(this.world.pause(),alert("You are dead !!!"),this.world.trigger("dead",{item:this}))))}}const $=new Map([["moving",[[...Array(9)].map(((t,e)=>O+"/demon/moving/"+(e+1)+".png")),!0]]]),C=new Map;class D extends f{static MOVING=new D("moving");get sprites(){return $.get(this.value)[0]}getAnimation(t){return C.has(t)||C.set(t,M(...$.get(this.value))),C.get(t)}}class q extends b{isEnemy=!0;isDead=!1;#o;get scoreGain(){return this.#o??=Math.ceil(500*Math.random())}get width(){return this.world.hero.width}get height(){return this.world.hero.height}get y(){return this.world.hero.maxY}set y(t){}#c;get x(){return this.#c??=this.world.width+Math.floor(Math.random()*this.world.width*Math.ceil(3*Math.random()))}set x(t){this.#c=t}state=D.MOVING;currentSprite=!1;draw(){const{ctx:t}=this;this.move(),this.x>this.world.width-this.width||t.drawImage(this.currentSprite,this.x,this.y,this.width,this.height)}move(){this.state=D.MOVING,this.currentSprite=this.state.getAnimation(this)(),this.x-=this.world.stage.speed,this.x<=0&&(this.#c=null)}destroy(){super.destroy(),this.isDead=!0}}const X=[...Array(8)].map(((t,e)=>A+"/stage"+(e+1)+".png"));class P extends b{level=0;enemies=0;enemiesPerStageRatio=5;get maxEnemies(){return this.stage*this.enemiesPerStageRatio}get stage(){return this.level+1}loops=0;loopIncreased=!1;get maxLoops(){return this.world.loopsToClearStage}speed=10;deltaX=0;x=0;y=0;get width(){return this.world.width}get height(){return this.world.height}#u;get decor(){this.#u??=new Image;const t=X[this.level]??X[0];return this.#u.src.endsWith(t)||(this.#u.src=t),this.#u}draw(){this.generateEnemies();const{decor:t,ctx:e}=this;this.deltaX+=this.speed,this.deltaX>=this.width&&(this.deltaX=0,this.loops++,this.loopIncreased=!0,console.debug(this.loops),this.loops>=this.maxLoops&&(this.world.pause(),this.world.trigger("stagecleared"),alert("stage cleared !!!"))),e.drawImage(t,this.deltaX,0,this.width-this.deltaX,this.height,0,0,this.width-this.deltaX,this.height),e.drawImage(t,0,0,this.deltaX,this.height,this.width-this.deltaX,0,this.deltaX,this.height)}generateEnemy(){this.enemies<this.maxEnemies&&this.world.objects.push(new q(this.world))}generateEnemies(){(0===this.enemies||this.loopIncreased)&&(this.loopIncreased&&(this.loopIncreased=!1),this.enemies<this.maxEnemies&&(this.generateEnemy(),this.enemies++))}}class J{#l;#d;get length(){return this.#l.length}constructor(t=!0){this.#l=[],this.#d=!0===t}on(t,e,s=!1){if(!a(t))throw new TypeError("Invalid event type, not a String.");if(!u(e))throw new TypeError("Invalid listener, not a function");return t.split(/\s+/).forEach((t=>{this.#l.push({type:t,listener:e,once:!0===s})})),this}one(t,e){return this.on(t,e,!0)}off(t,e){if(!a(t))throw new TypeError("Invalid event type, not a String.");return t.split(/\s+/).forEach((t=>{this.#l=this.#l.filter((s=>!!(t!==s.type||e!==s.listener&&e)))})),this}trigger(t,e=null,s=null){let i;if(s??=this.#d,t instanceof Event&&(i=t,i.data??=e,t=i.type),!a(t)&&t instanceof Event==!1)throw new TypeError("Invalid event type, not a String|Event.");const r=[];return t.split(/\s+/).forEach((t=>{if(!r.includes(t)){r.push(t);for(let r of function(t,e){return t.filter((t=>t.type===e))}(this.#l,t))r.type===t&&(s?d(r.listener,i??{type:t,data:e}):r.listener(i??{type:t,data:e}),r.once&&this.off(t,r.listener))}})),this}mixin(t){return t instanceof Object&&["on","off","one","trigger"].forEach((e=>{Object.defineProperty(t,e,{enumerable:!1,configurable:!0,value:(...s)=>(this[e](...s),t)})})),this}static mixin(t,e=!0){return new J(e).mixin(t)}static on(t,e,s=!1){return L.on(t,e,s)}static one(t,e){return L.one(t,e)}static off(t,e){return L.off(t,e)}static trigger(t,e=null,s=null){return L.trigger(t,e,s)}}const L=new J;let V={set(t,e,s){F.includes(s)&&this.remove(t,e),H(e).forEach((e=>{t.dataset[e]=p(s)}))},get(t,e,s=null){let i=H(e).map((e=>m(t.dataset[e]))).map((t=>F.includes(t)?s:t));return i.length<=1?i[0]??s:i},remove(t,e){H(e).forEach((e=>delete t.dataset[e]))}},F=[null,undefined];function H(t){let e=[];return a(t)&&(t.startsWith("data-")&&(t=t.slice(5)),e=[g(t)]),c(t)&&(e=e.concat(...t.map((t=>H(t))))),e}function W(t){return R(t)?[t]:t instanceof NodeList?[...t]:c(t)?t.filter((t=>R(t))):function(t){try{return a(t)&&null===r.createElement("template").querySelector(t)}catch(t){return!1}}(t)?[...document.querySelectorAll(t)]:[]}function R(t){return t instanceof Object&&t.dataset instanceof DOMStringMap}function K(t,e,s){function i(e,s=null){let i=t[0];return R(i)?V.get(i,e,s):s}function r(e,s){if((i=e)instanceof Object&&Object.getPrototypeOf(i)===Object.prototype)for(let t in e)r(t,e[t]);else t.forEach((t=>V.set(t,e,s)));var i;return n}t=W(t);const n={get:i,set:r,remove:function(e){return t.forEach((t=>V.remove(t,e))),n}};switch(arguments.length){case 2:return i(e);case 3:return r(e,s)}return n}let U=!1;class z{element;paused=!0;timeout=null;score=0;loopsToClearStage=10;objects=[];get ctx(){return this.canvas.getContext("2d")}get width(){return m(this.canvas.width)}get height(){return m(this.canvas.height)}get time(){const t=v.of(this.chrono.elapsed);return(t.hours>0?t.hours+":":"")+t.minutes+":"+t.seconds}constructor({element:t}={}){this.element=t,this.chrono=new x(!1),this.displayScore=t.querySelector("#score"),this.displayTime=t.querySelector("#time"),this.displayHP=t.querySelector("#lives"),this.canvas=t.querySelector("canvas"),J.mixin(this,!1)}destroy(){this.pause(),U=!1,this.objects.forEach((t=>t.destroy())),requestAnimationFrame((()=>this.clearScreen()))}destroyObject(t){if(t instanceof b){let e=this.objects.indexOf(t);e>-1&&(t.destroy(),this.objects.splice(e,1))}}init(){U||(this.stage=new P(this),this.hero=new N(this),this.objects.length=0,this.resume())}pause(){this.paused||(this.paused=!0,this.chrono.pause(),this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.trigger("paused"))}resume(){this.paused&&(this.paused=!1,this.chrono.stopped?(this.chrono.start(),this.trigger("started")):(this.chrono.resume(),this.trigger("resume")),requestAnimationFrame((()=>this.draw())))}clearScreen(){this.ctx.clearRect(0,0,this.width,this.height)}draw(){if(this.paused)return;const{displayScore:t,displayTime:e,displayHP:s}=this;this.clearScreen(),this.stage.draw(),this.objects.forEach((t=>t.draw())),this.hero.draw(),t.innerHTML=this.score,e.innerHTML=this.time,K(s,"lives",this.hero.hp),this.timeout=setTimeout((()=>{requestAnimationFrame((()=>this.draw()))}),16)}}const B=new z({element:document.querySelector("#game")});addEventListener("keydown",(t=>{const{key:e}=t;if(console.debug(e)," "===e){if(B.paused)return;t.preventDefault(),B.hero.isJumping||(B.hero.isJumping=!0)}else if("p"===e)t.preventDefault(),B.paused?B.resume():B.pause();else if("e"===e){if(B.paused)return;t.preventDefault(),B.hero.isAttacking||(B.hero.isAttacking=!0)}})),addEventListener("click",(({target:t})=>{B.paused||t.closest("#game")&&!B.hero.isAttacking&&(B.hero.isAttacking=!0)})),B.init();
